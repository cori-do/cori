{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://cori.do/schemas/RoleDefinition.schema.json",
  "title": "Cori Role Definition",
  "description": "Schema for defining AI agent roles with table permissions and column constraints. Role definitions control what AI agents can do when accessing the database via MCP.",
  "type": "object",
  "required": ["name"],
  "properties": {
    "name": {
      "type": "string",
      "description": "Unique identifier for this role (e.g., 'support_agent', 'analytics_agent').",
      "pattern": "^[a-z][a-z0-9_]*$",
      "examples": ["support_agent", "sales_agent", "admin_agent"]
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of the role's purpose and capabilities.",
      "examples": ["AI agent for customer support operations"]
    },
    "tables": {
      "type": "object",
      "description": "Table permissions configuration. Each key is a table name, and the value defines readable/creatable/updatable/deletable permissions.",
      "additionalProperties": {
        "$ref": "#/$defs/TablePermissions"
      }
    },
    "approvals": {
      "$ref": "#/$defs/ApprovalConfig",
      "description": "Default approval configuration for all requires_approval flags in this role. Can be overridden at individual field/action level."
    }
  },
  "$defs": {
    "TablePermissions": {
      "type": "object",
      "description": "Permission configuration for a single table. Define which columns can be read, created, updated, and whether deletion is allowed.",
      "properties": {
        "readable": {
          "$ref": "#/$defs/ReadableConfig",
          "description": "Columns that can be read (SELECT) and optional pagination limit. Use \"*\" for all columns, a list of column names, or {columns: [...], max_per_page: N} for columns with pagination limit."
        },
        "creatable": {
          "$ref": "#/$defs/CreatableColumns",
          "description": "Columns that can be set on INSERT. Use \"*\" for all columns, {} for none, or a map of column names to INSERT-specific constraints (required, default, restrict_to)."
        },
        "updatable": {
          "$ref": "#/$defs/UpdatableColumns",
          "description": "Columns that can be modified on UPDATE. Use \"*\" for all columns, {} for none, or a map of column names to UPDATE-specific constraints (restrict_to, transitions, only_when, increment_only, append_only)."
        },
        "deletable": {
          "$ref": "#/$defs/DeletablePermission",
          "description": "Whether records can be deleted from this table. Use false to deny, true to allow, or {requires_approval: true} to allow with human approval."
        }
      },
      "additionalProperties": false
    },
    "ColumnList": {
      "oneOf": [
        {
          "type": "string",
          "const": "*",
          "description": "All columns."
        },
        {
          "type": "array",
          "description": "List of specific column names.",
          "items": {
            "type": "string"
          },
          "uniqueItems": true
        }
      ],
      "examples": ["*", ["id", "name", "email", "created_at"]]
    },
    "ReadableConfig": {
      "oneOf": [
        {
          "type": "string",
          "const": "*",
          "description": "All columns."
        },
        {
          "type": "array",
          "description": "List of specific column names.",
          "items": {
            "type": "string"
          },
          "uniqueItems": true
        },
        {
          "type": "object",
          "description": "Readable configuration with columns and optional max_per_page limit.",
          "properties": {
            "columns": {
              "$ref": "#/$defs/ColumnList",
              "description": "Columns that can be read. Use \"*\" for all columns or a list of column names."
            },
            "max_per_page": {
              "type": "integer",
              "description": "Maximum number of rows returned by list actions for this table. Agents can request fewer rows but not more.",
              "minimum": 1,
              "examples": [50, 100, 500]
            }
          },
          "required": ["columns"],
          "additionalProperties": false
        }
      ],
      "examples": [
        "*",
        ["id", "name", "email", "created_at"],
        { "columns": ["id", "name", "email"], "max_per_page": 100 },
        { "columns": "*", "max_per_page": 500 }
      ]
    },
    "DeletablePermission": {
      "oneOf": [
        {
          "type": "boolean",
          "description": "true = deletion allowed, false = deletion denied."
        },
        {
          "type": "object",
          "description": "Deletion allowed with additional constraints.",
          "properties": {
            "requires_approval": {
              "$ref": "#/$defs/ApprovalRequirement",
              "description": "Whether deletion requires human approval. Use true for default group, or specify a group name."
            },
            "soft_delete": {
              "type": "boolean",
              "description": "If true, deletion is performed as a soft delete (e.g., setting a deleted_at column) instead of a hard delete. Defaults to false (hard delete).",
              "default": false
            }
          },
          "additionalProperties": false
        }
      ],
      "default": false,
      "examples": [
        false,
        true,
        { "requires_approval": true },
        { "requires_approval": { "group": "data_stewards" } },
        { "soft_delete": true },
        { "requires_approval": true, "soft_delete": true }
      ]
    },
    "CreatableColumns": {
      "oneOf": [
        {
          "type": "string",
          "const": "*",
          "description": "All columns are creatable with default (no) constraints."
        },
        {
          "type": "object",
          "description": "Map of column names to their INSERT constraints. Use {} for no creatable columns, or {column: {}} for a column with no constraints.",
          "additionalProperties": {
            "$ref": "#/$defs/CreatableColumnConstraints"
          }
        }
      ],
      "examples": [
        "*",
        {},
        {
          "subject": { "required": true, "guidance": "Use a clear, concise subject that summarizes the issue" },
          "priority": { "default": "medium", "restrict_to": ["low", "medium", "high"], "guidance": "Set to 'high' only for production-blocking issues" }
        }
      ]
    },
    "CreatableColumnConstraints": {
      "type": "object",
      "description": "Constraints on a column for INSERT operations. An empty object {} means the column is creatable with no constraints.",
      "properties": {
        "required": {
          "type": "boolean",
          "description": "If true, this role must provide a value for this column on INSERT (even if the database allows NULL).",
          "default": false,
          "examples": [true]
        },
        "default": {
          "description": "Role-specific default value if not provided. This is separate from the database default.",
          "examples": ["pending", "low", 0]
        },
        "restrict_to": {
          "type": "array",
          "description": "Subset of globally allowed values that this role can use. Must be a subset of allowed_values defined in ConstraintsDefinition.",
          "items": {},
          "uniqueItems": true,
          "examples": [["low", "medium", "high"], ["draft", "pending"]]
        },
        "requires_approval": {
          "$ref": "#/$defs/ApprovalRequirement",
          "description": "Whether creating a record with this column value requires human approval."
        },
        "guidance": {
          "type": "string",
          "description": "Instructions for AI agents on how to use this column when creating records. This text is included in the MCP tool schema to help LLMs make better decisions.",
          "examples": [
            "Use a clear, concise subject line that summarizes the customer's issue",
            "Set to 'high' only for production-blocking issues affecting multiple users",
            "Format as 'YYYY-MM-DD' for consistency"
          ]
        }
      },
      "additionalProperties": false
    },
    "UpdatableColumns": {
      "oneOf": [
        {
          "type": "string",
          "const": "*",
          "description": "All columns are updatable with default (no) constraints."
        },
        {
          "type": "object",
          "description": "Map of column names to their UPDATE constraints. Use {} for no updatable columns, or {column: {}} for a column with no constraints.",
          "additionalProperties": {
            "$ref": "#/$defs/UpdatableColumnConstraints"
          }
        }
      ],
      "examples": [
        "*",
        {},
        {
          "status": {
            "only_when": [
              { "old.status": "open", "new.status": ["in_progress", "cancelled"] },
              { "old.status": "in_progress", "new.status": ["resolved", "cancelled"] }
            ],
            "guidance": "Only mark as 'resolved' after confirming the issue is fully addressed"
          },
          "priority": { "requires_approval": true, "guidance": "Priority changes affect SLA timers - use sparingly" }
        },
        {
          "quantity": {
            "only_when": { "new.quantity": { "greater_than": "old.quantity" } },
            "guidance": "Quantity can only be increased"
          }
        },
        {
          "notes": {
            "only_when": { "new.notes": { "starts_with": "old.notes" } },
            "guidance": "Append new notes, don't edit existing content"
          }
        }
      ]
    },
    "UpdatableColumnConstraints": {
      "type": "object",
      "description": "Constraints on a column for UPDATE operations. An empty object {} means the column is updatable with no constraints.",
      "properties": {
        "only_when": {
          "$ref": "#/$defs/OnlyWhen",
          "description": "Conditions on current row (old.*) and incoming values (new.*). Use object for AND logic, array for OR logic."
        },
        "requires_approval": {
          "$ref": "#/$defs/ApprovalRequirement",
          "description": "Whether updating this column requires human approval."
        },
        "guidance": {
          "type": "string",
          "description": "Instructions for AI agents on how to use this column when updating records. This text is included in the MCP tool schema to help LLMs make better decisions.",
          "examples": [
            "Only mark as 'resolved' after confirming the customer's issue is fully addressed",
            "Append resolution notes with timestamp and action taken",
            "Escalate to 'critical' only if SLA breach is imminent"
          ]
        }
      },
      "additionalProperties": false
    },
    "OnlyWhen": {
      "oneOf": [
        {
          "type": "object",
          "description": "Single condition set (AND logic). Keys are 'old.<column>' for current row values or 'new.<column>' for incoming values.",
          "additionalProperties": {
            "$ref": "#/$defs/ColumnCondition"
          }
        },
        {
          "type": "array",
          "description": "Multiple condition sets (OR logic). Update is allowed if ANY condition set matches. Each item uses AND logic internally.",
          "items": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/$defs/ColumnCondition"
            }
          },
          "minItems": 1
        }
      ],
      "examples": [
        { "old.status": ["open", "in_progress"], "new.status": ["resolved", "closed"] },
        { "new.quantity": { "greater_than": "old.quantity" } },
        { "new.notes": { "starts_with": "old.notes" } },
        [
          { "old.status": "open", "new.status": ["in_progress", "cancelled"] },
          { "old.status": "in_progress", "new.status": ["resolved", "cancelled"] }
        ]
      ]
    },
    "ColumnCondition": {
      "oneOf": [
        {
          "description": "Single value - column must equal this value.",
          "not": {
            "type": ["array", "object"]
          }
        },
        {
          "type": "array",
          "description": "Column must have one of these values (IN operator).",
          "items": {}
        },
        {
          "type": "object",
          "description": "Comparison condition. Values can be literals or references to other columns using 'old.<column>' syntax.",
          "properties": {
            "equals": {
              "description": "Column must equal this value (explicit form of default behavior)."
            },
            "not_equals": {
              "description": "Column must not equal this value."
            },
            "greater_than": {
              "$ref": "#/$defs/NumberOrColumnRef",
              "description": "Column must be greater than this value or another column (e.g., 'old.quantity')."
            },
            "greater_than_or_equal": {
              "$ref": "#/$defs/NumberOrColumnRef",
              "description": "Column must be greater than or equal to this value or another column."
            },
            "lower_than": {
              "$ref": "#/$defs/NumberOrColumnRef",
              "description": "Column must be lower than this value or another column."
            },
            "lower_than_or_equal": {
              "$ref": "#/$defs/NumberOrColumnRef",
              "description": "Column must be lower than or equal to this value or another column."
            },
            "not_null": {
              "type": "boolean",
              "description": "If true, column must not be null."
            },
            "is_null": {
              "type": "boolean",
              "description": "If true, column must be null."
            },
            "in": {
              "type": "array",
              "description": "Column must be one of these values.",
              "items": {}
            },
            "not_in": {
              "type": "array",
              "description": "Column must not be one of these values.",
              "items": {}
            },
            "starts_with": {
              "type": "string",
              "description": "Column must start with this value or another column (e.g., 'old.notes' for append-only).",
              "examples": ["old.notes", "PREFIX_"]
            }
          },
          "additionalProperties": false
        }
      ],
      "examples": [
        "active",
        ["open", "in_progress"],
        { "greater_than": 0 },
        { "greater_than": "old.quantity" },
        { "lower_than_or_equal": 100 },
        { "not_null": true },
        { "not_in": ["archived", "deleted"] },
        { "starts_with": "old.notes" }
      ]
    },
    "NumberOrColumnRef": {
      "oneOf": [
        {
          "type": "number",
          "description": "A literal numeric value."
        },
        {
          "type": "string",
          "description": "Reference to another column using 'old.<column>' or 'new.<column>' syntax.",
          "pattern": "^(old|new)\\.[a-zA-Z_][a-zA-Z0-9_]*$",
          "examples": ["old.quantity", "old.price", "new.total"]
        }
      ]
    },
    "ApprovalRequirement": {
      "oneOf": [
        {
          "type": "boolean",
          "description": "true = requires approval from the group defined in role's 'approvals' config, false = no approval needed."
        },
        {
          "$ref": "#/$defs/ApprovalConfig"
        }
      ],
      "examples": [
        true,
        false,
        { "group": "support_managers" },
        { "group": "security_team", "notify_on_pending": true, "message": "Sensitive data access requires security approval" }
      ]
    },
    "ApprovalConfig": {
      "type": "object",
      "description": "Approval configuration specifying which group can approve and notification settings.",
      "required": ["group"],
      "properties": {
        "group": {
          "type": "string",
          "description": "Name of the approval group (must be defined in groups/ folder).",
          "pattern": "^[a-z][a-z0-9_]*$",
          "examples": ["support_managers", "security_team", "data_stewards"]
        },
        "notify_on_pending": {
          "type": "boolean",
          "description": "Whether to send notifications to group members when approvals are pending.",
          "default": true
        },
        "message": {
          "type": "string",
          "description": "Custom message to display to approvers explaining why approval is needed.",
          "examples": ["This change affects billing data and requires finance team approval."]
        }
      },
      "additionalProperties": false,
      "examples": [
        { "group": "support_managers" },
        { "group": "admins", "notify_on_pending": true },
        { "group": "security_team", "message": "Security approval required" }
      ]
    }
  },
  "examples": [
    {
      "name": "support_agent",
      "description": "AI agent for customer support operations",
      "approvals": {
        "group": "support_managers",
        "notify_on_pending": true
      },
      "tables": {
        "customers": {
          "readable": {
            "columns": ["id", "name", "email", "plan", "created_at"],
            "max_per_page": 100
          },
          "creatable": {},
          "updatable": {},
          "deletable": false
        },
        "tickets": {
          "readable": {
            "columns": ["id", "customer_id", "subject", "status", "priority", "created_at"],
            "max_per_page": 100
          },
          "creatable": {
            "subject": { "required": true },
            "description": { "required": true },
            "customer_id": { "required": true },
            "priority": {
              "default": "medium",
              "restrict_to": ["low", "medium", "high"]
            },
            "status": {
              "default": "open",
              "restrict_to": ["open"]
            }
          },
          "updatable": {
            "status": {
              "only_when": [
                { "old.status": "open", "new.status": ["in_progress", "resolved"] },
                { "old.status": "in_progress", "new.status": ["open", "resolved", "escalated"] },
                { "old.status": "resolved", "new.status": "open" }
              ]
            },
            "priority": {
              "only_when": { "new.priority": ["low", "medium", "high"] },
              "requires_approval": true
            },
            "description": {
              "only_when": {
                "old.status": ["open", "in_progress"],
                "new.description": { "starts_with": "old.description" }
              }
            }
          },
          "deletable": false
        }
      }
    },
    {
      "name": "warehouse_agent",
      "description": "AI agent for warehouse and shipping operations",
      "approvals": {
        "group": "warehouse_managers"
      },
      "tables": {
        "orders": {
          "readable": {
            "columns": "*",
            "max_per_page": 500
          },
          "creatable": {},
          "updatable": {
            "status": {
              "only_when": [
                { "old.status": "paid", "new.status": "shipped", "old.shipping_address": { "not_null": true } },
                { "old.status": "shipped", "new.status": "delivered" }
              ]
            },
            "tracking_number": {},
            "shipped_at": {}
          },
          "deletable": false
        },
        "inventory": {
          "readable": {
            "columns": ["id", "product_id", "quantity", "warehouse_id"],
            "max_per_page": 500
          },
          "creatable": {},
          "updatable": {
            "quantity": {
              "only_when": { "new.quantity": { "greater_than": "old.quantity" } },
              "guidance": "Quantity can only be increased, never decreased"
            }
          },
          "deletable": false
        }
      }
    },
    {
      "name": "admin_agent",
      "description": "Administrative agent with broad access",
      "approvals": {
        "group": "admins"
      },
      "tables": {
        "customers": {
          "readable": {
            "columns": "*",
            "max_per_page": 1000
          },
          "creatable": "*",
          "updatable": "*",
          "deletable": true
        },
        "orders": {
          "readable": {
            "columns": "*",
            "max_per_page": 1000
          },
          "creatable": {
            "customer_id": { "required": true },
            "items": { "required": true },
            "status": { "default": "pending" },
            "notes": {}
          },
          "updatable": {
            "status": {
              "only_when": { "new.status": ["pending", "shipped", "delivered", "cancelled"] }
            }
          }
        }
      }
    }
      ]
    }
