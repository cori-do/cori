{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://cori.do/schemas/MutationIntent.schema.json",
    "title": "MutationIntent",
    "type": "object",
    "additionalProperties": false,
    "required": ["intent_id", "tenant_id", "environment", "preview", "principal", "plan"],
    "properties": {
      "schema_version": {
        "type": "string",
        "default": "0.1.0",
        "description": "Protocol/schema version for forwards/backwards compatibility."
      },
  
      "intent_id": {
        "type": "string",
        "minLength": 1,
        "maxLength": 256,
        "description": "Idempotency key for the full intent."
      },
  
      "tenant_id": { "type": "string", "minLength": 1, "maxLength": 256 },
  
      "environment": {
        "type": "string",
        "minLength": 1,
        "maxLength": 64,
        "description": "Typically: prod|staging|dev (kept open for custom env names)."
      },
  
      "preview": {
        "type": "boolean",
        "description": "If true, the runtime MUST NOT apply side effects; it should return diffs/counts only."
      },
  
      "principal": { "$ref": "#/$defs/Principal" },
  
      "plan": { "$ref": "Plan.schema.json" },
  
      "request": {
        "type": "object",
        "description": "Optional user request metadata (e.g., original NL request, ticket id).",
        "additionalProperties": true
      },
  
      "meta": {
        "type": "object",
        "description": "Free-form extension metadata (non-authoritative).",
        "additionalProperties": true
      }
    },
    "$defs": {
      "Principal": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "roles", "attrs"],
        "properties": {
          "id": { "type": "string", "minLength": 1, "maxLength": 256 },
          "roles": {
            "type": "array",
            "items": { "type": "string", "minLength": 1, "maxLength": 128 },
            "uniqueItems": true
          },
          "attrs": {
            "type": "object",
            "description": "Arbitrary attributes passed to policy evaluation (department, region, risk level, etc.).",
            "additionalProperties": true
          }
        }
      }
    }
  }
  