# =============================================================================
# Tenancy Configuration for CRM Multi-Tenant Database
# =============================================================================
# This file declares HOW multi-tenancy is structured for this database.
# It defines:
#   - The tenant identifier type
#   - Which column holds tenant IDs in each table
#   - Tables that inherit tenant via FK relationships (tenant_via)
#   - Which tables are global (shared across tenants)
#
# This is separate from roles (access control) — tenancy is about database
# structure, roles are about who can do what.
#
# NOTE: In this demo, all tables have a direct `organization_id` column.
# See the "FK-INHERITED TENANCY" section below for examples of tables
# that would inherit tenant context via foreign key chains.
# =============================================================================

# =============================================================================
# TENANT IDENTIFIER
# =============================================================================
# The canonical tenant identifier used in Biscuit tokens and RLS predicates.
# In this demo, organization_id is an INTEGER (serial).

tenant_id:
  type: integer
  description: "Organization ID - integer identifier for tenant"

# =============================================================================
# TABLE CONFIGURATION
# =============================================================================
# For each table, declare which column holds the tenant identifier.
# Tables not listed here will use auto-detection.

tables:
  # -----------------------------------------------------------------------------
  # Core tenant-scoped tables (direct tenant column)
  # -----------------------------------------------------------------------------
  customers:
    tenant_column: organization_id
    tenant_type: integer

  contacts:
    tenant_column: organization_id
    tenant_type: integer

  orders:
    tenant_column: organization_id
    tenant_type: integer

  order_items:
    tenant_column: organization_id
    tenant_type: integer

  tickets:
    tenant_column: organization_id
    tenant_type: integer

  communications:
    tenant_column: organization_id
    tenant_type: integer

  notes:
    tenant_column: organization_id
    tenant_type: integer

  # -----------------------------------------------------------------------------
  # FK-INHERITED TENANCY (Examples)
  # -----------------------------------------------------------------------------
  # Some tables may not have a direct tenant column but inherit tenant context
  # via foreign key relationships. Use `tenant_via` to specify the FK chain.
  #
  # Example: If order_items didn't have organization_id, it would inherit
  # tenant context from orders via the order_id FK:
  #
  # order_items:
  #   tenant_via: orders.order_id
  #   fk_column: order_id
  #   # Cori will generate: JOIN orders ON order_items.order_id = orders.order_id
  #   # Then apply: WHERE orders.organization_id = <tenant>
  #
  # Multi-hop example (invoice_line_items → invoices → orders):
  #
  # invoice_line_items:
  #   tenant_via: invoices.invoice_id
  #   fk_column: invoice_id
  #   # Chain: invoice_line_items → invoices → (invoices has organization_id)
  #
  # Deep chain example (payment_notes → payments → invoices → orders):
  #
  # payment_notes:
  #   tenant_via: payments.payment_id
  #   fk_column: payment_id
  #   # Cori traces: payments → invoices → (invoices has organization_id)
  #   # Generated JOIN chain enforces tenant isolation
  # -----------------------------------------------------------------------------

  # -----------------------------------------------------------------------------
  # Global tables (shared across all tenants)
  # -----------------------------------------------------------------------------
  # These are reference/lookup tables that don't contain tenant-specific data.
  # Note: In this demo, products ARE tenant-scoped (each org has their own catalog)
  
  products:
    tenant_column: organization_id
    tenant_type: integer

  users:
    # Users table is special - it's tenant-scoped but contains admin accounts
    tenant_column: organization_id
    tenant_type: integer

  organizations:
    # The organizations table itself - tenant_id IS the primary key
    # Agents can only see their own organization
    tenant_column: organization_id
    tenant_type: integer

# =============================================================================
# AUTO-DETECTION (Fallback)
# =============================================================================
# For tables not explicitly configured, Cori will look for these columns.

auto_detect:
  enabled: true
  columns:
    - organization_id
    - tenant_id
    - org_id
