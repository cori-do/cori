# =============================================================================
# SUPPORT AGENT ROLE
# =============================================================================
# Customer support agent with access to customer-facing data.
# Can view most data, limited write access to tickets/issues.
# Conforms to: RoleDefinition.schema.json
# =============================================================================

name: support_agent
description: "AI agent for customer support operations"

# Default approval group for requires_approval flags
approvals:
  group: support_managers
  notify_on_pending: true

tables:
  contacts:
    readable: [contact_id, organization_id, customer_id, first_name, last_name, position, email, phone, is_primary, created_at, updated_at]
    # Read-only access for this table

  customer_tags:
    readable: [customer_id, tag_id, organization_id, created_at]
    # Read-only access for this table

  customers:
    readable: [customer_id, organization_id, first_name, last_name, email, phone, company, status, notes, lifetime_value, created_at, updated_at]
    # Read-only access for this table

  notes:
    readable: [note_id, organization_id, created_by, customer_id, opportunity_id, ticket_id, content, is_internal, created_at, updated_at]
    # Read-only access for this table

  order_items:
    readable: [order_item_id, organization_id, order_id, product_id, quantity, unit_price, discount_percentage, line_total, created_at, updated_at]
    # Read-only access for this table

  orders:
    readable: [order_id, organization_id, customer_id, opportunity_id, created_by, order_number, order_date, status, shipping_address_id, billing_address_id, shipping_cost, tax_amount, discount_amount, subtotal, total_amount, notes, created_at, updated_at]
    # Read-only access for this table

  products:
    readable: [product_id, organization_id, name, description, sku, price, cost, category, stock_quantity, is_active, created_at, updated_at]
    # Read-only access for this table

  tickets:
    readable: [ticket_id, organization_id, customer_id, assigned_to, ticket_number, subject, description, status, priority, category, resolved_at, created_at, updated_at]
    creatable:
      # Foreign key with verification - agent provides customer_id AND verifiable info
      # Cori validates: customer exists, matches email, AND belongs to same tenant
      # The referenced table is inferred from the database schema's foreign key definitions
      customer_id:
        required: true
        foreign_key:
          verify_with: [email]
        guidance: "Provide customer_id and customer_email for verification"
      # Ticket number - agent must provide a unique identifier
      ticket_number:
        required: true
        guidance: "Provide a unique ticket number (e.g., 'TICKET-001')"
      # User-provided fields
      subject:
        required: true
        guidance: "Use a clear, concise subject that summarizes the customer's issue"
      description:
        guidance: "Detailed description of the issue"
      priority:
        default: "medium"
        restrict_to: ["low", "medium", "high"]
        guidance: "Set to 'high' only for production-blocking issues"
      category:
        restrict_to: ["billing", "technical", "general", "feature_request"]
      # Note: organization_id is auto-filled from Biscuit token (detected from rules.yaml)
    updatable:
      status:
        only_when:
          - old.status: open
            new.status: [in_progress, pending_customer, resolved, closed]
          - old.status: in_progress
            new.status: [open, pending_customer, resolved, closed]
          - old.status: pending_customer
            new.status: [open, in_progress, resolved, closed]
          - old.status: resolved
            new.status: [open, closed]
        guidance: "Update ticket status based on resolution progress"
      priority:
        requires_approval: true
        guidance: "Priority changes require manager approval"
    deletable: false

default_page_size: 100
